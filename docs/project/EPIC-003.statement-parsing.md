# EPIC-003: æ™ºèƒ½å¯¹è´¦å•è§£æ

> **Status**: â³ Pending  
> **Phase**: 2  
> **å‘¨æœŸ**: 3 å‘¨  
> **ä¾èµ–**: EPIC-002  

---

## ğŸ¯ ç›®æ ‡

ä½¿ç”¨ Gemini 3 Flash Vision è§£æé“¶è¡Œ/åˆ¸å•†å¯¹è´¦å•ï¼Œè‡ªåŠ¨æå–äº¤æ˜“æ˜ç»†å¹¶ç”Ÿæˆå€™é€‰åˆ†å½•ã€‚

**æ ¸å¿ƒæµç¨‹**:
```
Upload â†’ Gemini Vision â†’ JSON â†’ Validation â†’ BankStatementTransaction â†’ å€™é€‰ JournalEntry
```

---

## ğŸ‘¥ è§’è‰²å®¡è®®

| è§’è‰² | å…³æ³¨ç‚¹ | å®¡è®®æ„è§ |
|------|--------|----------|
| ğŸ—ï¸ **Architect** | è§£è€¦è®¾è®¡ | AI åªåšè§£æï¼Œä¸ç›´æ¥å†™å…¥è´¦æœ¬ï¼Œé€šè¿‡éªŒè¯å±‚è¿‡æ»¤é”™è¯¯ |
| ğŸ’» **Developer** | API é›†æˆ | Gemini 3 Flash è°ƒç”¨å°è£…ï¼Œå«é‡è¯•ã€é™çº§ã€æˆæœ¬æ§åˆ¶ |
| ğŸ“Š **Accountant** | æ•°æ®å®Œæ•´æ€§ | æœŸåˆ + æµæ°´ â‰ˆ æœŸæœ«ï¼ŒéªŒè¯ä¸é€šè¿‡åˆ™æ‹’ç»å…¥åº“ |
| ğŸ”— **Reconciler** | ä¸‹æ¸¸ä¾èµ– | è§£æç»“æœå¿…é¡»ç»“æ„åŒ–ï¼Œæ–¹ä¾¿åç»­åŒ¹é…ç®—æ³•ä½¿ç”¨ |
| ğŸ§ª **Tester** | è§£æå‡†ç¡®ç‡ | å¤šé“¶è¡Œã€å¤šæ ¼å¼è¦†ç›–æµ‹è¯•ï¼Œç›®æ ‡ â‰¥ 95% |
| ğŸ“‹ **PM** | ç”¨æˆ·ä½“éªŒ | æ‹–æ‹½ä¸Šä¼ ã€è§£æè¿›åº¦ã€é”™è¯¯æç¤ºå‹å¥½ |

---

## âœ… ä»»åŠ¡æ¸…å•

### æ•°æ®æ¨¡å‹ (Backend)

- [ ] `BankStatement` æ¨¡å‹ - å¯¹è´¦å•å¤´ (account_id, period, opening/closing_balance)
- [ ] `BankStatementTransaction` æ¨¡å‹ - äº¤æ˜“æ˜ç»† (txn_date, amount, direction, description)
- [ ] Alembic è¿ç§»è„šæœ¬
- [ ] Pydantic Schema

### Gemini é›†æˆ (Backend)

- [ ] `services/extraction.py` - æ–‡æ¡£è§£ææœåŠ¡
  - [ ] `parse_pdf()` - PDF è§£æ (Vision API)
  - [ ] `parse_csv()` - CSV è§£æ (è§„åˆ™ + AI è¾…åŠ©)
  - [ ] `parse_xlsx()` - Excel è§£æ
- [ ] Prompt æ¨¡æ¿ç®¡ç†
  - [ ] DBS/POSB å¯¹è´¦å•æ¨¡æ¿
  - [ ] OCBC å¯¹è´¦å•æ¨¡æ¿
  - [ ] ä¿¡ç”¨å¡è´¦å•é€šç”¨æ¨¡æ¿
- [ ] è§£æç»“æœç»“æ„åŒ–
  ```python
  class ParsedStatement:
      bank_name: str
      account_number: str  # å4ä½
      period_start: date
      period_end: date
      opening_balance: Decimal
      closing_balance: Decimal
      transactions: list[ParsedTransaction]
  ```

### éªŒè¯å±‚ (Backend)

- [ ] `services/validation.py` - éªŒè¯æœåŠ¡
  - [ ] `validate_balance()` - æœŸåˆ + æµæ°´ â‰ˆ æœŸæœ« (å®¹å·® 0.1 USD)
  - [ ] `validate_completeness()` - å¿…å¡«å­—æ®µæ£€æŸ¥
  - [ ] `detect_duplicates()` - é‡å¤å¯¼å…¥æ£€æµ‹
- [ ] éªŒè¯å¤±è´¥å¤„ç†
  - [ ] æ ‡è®°ä¸º "éœ€äººå·¥å¤æ ¸"
  - [ ] è®°å½•å¤±è´¥åŸå› 
  - [ ] é€šçŸ¥ç”¨æˆ·

### API ç«¯ç‚¹ (Backend)

- [ ] `POST /api/statements/upload` - æ–‡ä»¶ä¸Šä¼ 
- [ ] `GET /api/statements` - å¯¹è´¦å•åˆ—è¡¨
- [ ] `GET /api/statements/{id}` - å¯¹è´¦å•è¯¦æƒ…ï¼ˆå«äº¤æ˜“æ˜ç»†ï¼‰
- [ ] `POST /api/statements/{id}/approve` - ç¡®è®¤å¯¹è´¦å•
- [ ] `POST /api/statements/{id}/reject` - æ‹’ç»å¯¹è´¦å•
- [ ] `GET /api/statements/{id}/transactions` - äº¤æ˜“æ˜ç»†åˆ—è¡¨

### å‰ç«¯ç•Œé¢ (Frontend)

- [ ] `/upload` - ä¸Šä¼ é¡µé¢
  - [ ] æ‹–æ‹½ä¸Šä¼ ç»„ä»¶
  - [ ] æ–‡ä»¶ç±»å‹/å¤§å°éªŒè¯
  - [ ] ä¸Šä¼ è¿›åº¦æ¡
  - [ ] è§£æçŠ¶æ€è½®è¯¢
- [ ] `/statements` - å¯¹è´¦å•ç®¡ç†
  - [ ] å¯¹è´¦å•åˆ—è¡¨ï¼ˆçŠ¶æ€æ ‡ç­¾ï¼‰
  - [ ] å¯¹è´¦å•è¯¦æƒ…ï¼ˆäº¤æ˜“æ˜ç»†è¡¨æ ¼ï¼‰
  - [ ] è§£æç»“æœé¢„è§ˆ
  - [ ] ç¡®è®¤/æ‹’ç»æ“ä½œ
- [ ] é”™è¯¯å¤„ç†
  - [ ] è§£æå¤±è´¥æç¤º
  - [ ] éªŒè¯å¤±è´¥è¯¦æƒ…
  - [ ] é‡è¯•å…¥å£

---

## ğŸ“ åšå¾—å¥½ä¸å¥½çš„æ ‡å‡†

### ğŸŸ¢ åˆæ ¼æ ‡å‡† (Must Have)

| æ ‡å‡† | éªŒè¯æ–¹æ³• | æƒé‡ |
|------|----------|------|
| **è§£ææˆåŠŸç‡ â‰¥ 95%** | 10 ä»½çœŸå®å¯¹è´¦å•æµ‹è¯• | ğŸ”´ å…³é”® |
| **ä½™é¢éªŒè¯ 100% æ‰§è¡Œ** | æœŸåˆ+æµæ°´â‰ˆæœŸæœ«æ£€æŸ¥ | ğŸ”´ å…³é”® |
| **è§£æé”™è¯¯ä¸å…¥åº“** | éªŒè¯å¤±è´¥è¿”å›é”™è¯¯ | ğŸ”´ å…³é”® |
| æ”¯æŒ PDF æ ¼å¼ (DBS, OCBC) | é“¶è¡Œæ ·æœ¬æµ‹è¯• | å¿…é¡» |
| æ”¯æŒ CSV é€šç”¨æ ¼å¼ | æ ‡å‡† CSV æµ‹è¯• | å¿…é¡» |
| æ–‡ä»¶å¤§å°é™åˆ¶ 10MB | ä¸Šä¼ éªŒè¯ | å¿…é¡» |
| è§£ææ—¶é—´ < 30s | æ€§èƒ½æµ‹è¯• | å¿…é¡» |

### ğŸŒŸ ä¼˜ç§€æ ‡å‡† (Nice to Have)

| æ ‡å‡† | éªŒè¯æ–¹æ³• | çŠ¶æ€ |
|------|----------|------|
| æ”¯æŒ XLSX æ ¼å¼ | Excel æ ·æœ¬æµ‹è¯• | â³ |
| è§£æç»“æœå¯ç¼–è¾‘ | å‰ç«¯è¡¨æ ¼ç¼–è¾‘ | â³ |
| æ‰¹é‡ä¸Šä¼  | å¤šæ–‡ä»¶é˜Ÿåˆ—å¤„ç† | â³ |
| è§£æç¼“å­˜ | ç›¸åŒæ–‡ä»¶ä¸é‡å¤è°ƒç”¨ API | â³ |
| Gemini æˆæœ¬æŠ¥å‘Š | Token ä½¿ç”¨ç»Ÿè®¡ | â³ |

### ğŸš« ä¸åˆæ ¼ä¿¡å·

- è§£ææˆåŠŸç‡ < 90%
- ä½™é¢éªŒè¯è¢«è·³è¿‡
- è§£æé”™è¯¯æ•°æ®è¿›å…¥è´¦æœ¬
- Gemini API é¢‘ç¹è¶…æ—¶
- ç”¨æˆ·æ— æ³•ç†è§£é”™è¯¯åŸå› 

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### å•å…ƒæµ‹è¯• (å¿…é¡»)

```python
# ä½™é¢éªŒè¯
def test_balance_validation_passes():
    """æœŸåˆ 1000 + æµæ°´ 500 - 300 = æœŸæœ« 1200"""

def test_balance_validation_fails():
    """æœŸåˆ 1000 + æµæ°´ 500 â‰  æœŸæœ« 1600"""

# è§£æç»“æœ
def test_parse_dbs_pdf():
    """DBS å¯¹è´¦å•è§£æï¼Œå­—æ®µå®Œæ•´"""

def test_parse_invalid_pdf():
    """éå¯¹è´¦å• PDF åº”è¿”å›è§£æå¤±è´¥"""
```

### é›†æˆæµ‹è¯• (å¿…é¡»)

```python
def test_upload_and_parse_flow():
    """å®Œæ•´ä¸Šä¼ â†’è§£æâ†’éªŒè¯â†’å…¥åº“æµç¨‹"""

def test_duplicate_upload_detection():
    """é‡å¤ä¸Šä¼ åŒä¸€æ–‡ä»¶åº”æç¤º"""

def test_gemini_retry_on_timeout():
    """Gemini è¶…æ—¶åº”è‡ªåŠ¨é‡è¯•"""
```

### æ ·æœ¬è¦†ç›– (å¿…é¡»)

| é“¶è¡Œ | æ ¼å¼ | æ ·æœ¬æ•° | é¢„æœŸå‡†ç¡®ç‡ |
|------|------|--------|------------|
| DBS/POSB | PDF | 3 | â‰¥ 95% |
| OCBC | PDF | 2 | â‰¥ 95% |
| ä¿¡ç”¨å¡ | PDF | 3 | â‰¥ 90% |
| é€šç”¨ | CSV | 2 | â‰¥ 98% |

---

## ğŸ“š SSOT å¼•ç”¨

- [schema.md](../ssot/schema.md) - BankStatement/BankStatementTransaction è¡¨
- [extraction.md](../ssot/extraction.md) - è§£æè§„åˆ™ä¸ Prompt è®¾è®¡

---

## ğŸ”— äº¤ä»˜ç‰©

- [ ] `apps/backend/src/models/statement.py`
- [ ] `apps/backend/src/services/extraction.py`
- [ ] `apps/backend/src/services/validation.py`
- [ ] `apps/backend/src/routers/statements.py`
- [ ] `apps/frontend/app/upload/page.tsx`
- [ ] `apps/frontend/app/statements/page.tsx`
- [ ] æ›´æ–° `docs/ssot/extraction.md` (Prompt æ¨¡æ¿)
- [ ] æµ‹è¯•æ ·æœ¬é›† `tests/fixtures/statements/`

---

## ğŸ“ æŠ€æœ¯å€ºåŠ¡

| é¡¹ç›® | ä¼˜å…ˆçº§ | è®¡åˆ’è§£å†³æ—¶é—´ |
|------|--------|--------------|
| æœ¬åœ° PDF è§£æé™çº§ | P2 | åç»­è¿­ä»£ |
| æ›´å¤šé“¶è¡Œæ”¯æŒ (UOB, Citi) | P3 | åç»­è¿­ä»£ |
| OCR é¢„å¤„ç† (æ‰«æä»¶) | P3 | åç»­è¿­ä»£ |

---

## â“ Q&A (å¾…ç¡®è®¤é—®é¢˜)

### Q1: æ”¯æŒçš„é“¶è¡Œä¼˜å…ˆçº§
> **é—®é¢˜**: ç¬¬ä¸€ç‰ˆéœ€è¦æ”¯æŒå“ªäº›é“¶è¡Œçš„å¯¹è´¦å•ï¼Ÿ  
> **é€‰é¡¹**:
> - A) ä»… DBS/POSB
> - B) DBS + OCBC + ä¿¡ç”¨å¡
> - C) æ‰€æœ‰æ–°åŠ å¡ä¸»æµé“¶è¡Œ
>
> **å½±å“**: å½±å“ Prompt æ¨¡æ¿å¼€å‘å·¥ä½œé‡  
> **å»ºè®®**: é€‰æ‹© Bï¼Œè¦†ç›– 80% ä½¿ç”¨åœºæ™¯

**ä½ çš„å›ç­”**: _________________

### Q2: Gemini API æˆæœ¬æ§åˆ¶
> **é—®é¢˜**: å¦‚ä½•æ§åˆ¶ Gemini API è°ƒç”¨æˆæœ¬ï¼Ÿ  
> **é€‰é¡¹**:
> - A) æ— é™åˆ¶ï¼ˆä¸ªäººä½¿ç”¨é‡å°ï¼‰
> - B) æ¯æ—¥è°ƒç”¨ä¸Šé™
> - C) æ¯ä»½å¯¹è´¦å•è§£æåç¼“å­˜ 30 å¤©
>
> **å½±å“**: å½±å“ API è°ƒç”¨é€»è¾‘å’Œç”¨æˆ·ä½“éªŒ  
> **å»ºè®®**: é€‰æ‹© Cï¼Œç¼“å­˜è§£æç»“æœ

**ä½ çš„å›ç­”**: _________________

### Q3: è§£æå¤±è´¥çš„å¤„ç†æ–¹å¼
> **é—®é¢˜**: è§£æå¤±è´¥æ—¶ç”¨æˆ·å¯ä»¥åšä»€ä¹ˆï¼Ÿ  
> **é€‰é¡¹**:
> - A) ä»…æç¤ºå¤±è´¥ï¼Œç”¨æˆ·æ‰‹åŠ¨å½•å…¥
> - B) æ˜¾ç¤ºéƒ¨åˆ†è§£æç»“æœï¼Œç”¨æˆ·å¯ç¼–è¾‘è¡¥å……
> - C) æ”¯æŒé‡è¯• + äººå·¥ç¼–è¾‘
>
> **å½±å“**: å½±å“å‰ç«¯äº¤äº’è®¾è®¡  
> **å»ºè®®**: é€‰æ‹© Cï¼Œæä¾›æœ€å¤§çµæ´»æ€§

**ä½ çš„å›ç­”**: _________________

### Q4: å¯¹è´¦å•è´¦æˆ·å…³è”
> **é—®é¢˜**: ä¸Šä¼ å¯¹è´¦å•æ—¶å¦‚ä½•å…³è”åˆ°å…·ä½“è´¦æˆ·ï¼Ÿ  
> **é€‰é¡¹**:
> - A) ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©è´¦æˆ·
> - B) æ ¹æ®å¯¹è´¦å•å†…å®¹è‡ªåŠ¨åŒ¹é…ï¼ˆè´¦å·å 4 ä½ï¼‰
> - C) å…ˆè§£æï¼Œå†è®©ç”¨æˆ·ç¡®è®¤å…³è”
>
> **å½±å“**: å½±å“ä¸Šä¼ æµç¨‹è®¾è®¡  
> **å»ºè®®**: é€‰æ‹© Cï¼ŒAI å»ºè®® + ç”¨æˆ·ç¡®è®¤

**ä½ çš„å›ç­”**: _________________

### Q5: å†å²å¯¹è´¦å•å¯¼å…¥
> **é—®é¢˜**: æ˜¯å¦éœ€è¦æ”¯æŒå¯¼å…¥å†å²å¯¹è´¦å•ï¼ˆå¦‚ 2024 å¹´å…¨å¹´ï¼‰ï¼Ÿ  
> **å½±å“**: å½±å“æ‰¹é‡å¤„ç†å’Œæ€§èƒ½è®¾è®¡  
> **å»ºè®®**: ç¬¬ä¸€ç‰ˆæ”¯æŒå•ä»½ä¸Šä¼ ï¼Œæ‰¹é‡å¯¼å…¥ä½œä¸º P2

**ä½ çš„å›ç­”**: _________________

---

## ğŸ“… æ—¶é—´çº¿

| é˜¶æ®µ | å†…å®¹ | é¢„è®¡å·¥æ—¶ |
|------|------|----------|
| Week 1 | æ•°æ®æ¨¡å‹ + Gemini é›†æˆ | 16h |
| Week 2 | éªŒè¯å±‚ + API + Prompt è°ƒä¼˜ | 20h |
| Week 3 | å‰ç«¯ç•Œé¢ + å¤šé“¶è¡Œæµ‹è¯• | 16h |

**æ€»é¢„è®¡**: 52 å°æ—¶ (3 å‘¨)
