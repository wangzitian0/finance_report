# QA & Standardization Report

## Executive Summary
Executed "Shift Left" strategy to catch common pitfalls early in the development cycle.
Implemented 4 layers of defense:

1.  **Environment Variables (The "Triangle of Death")**
    -   **Documentation**: Added `Variable Lifecycle` flowchart to `development.md`.
    -   **Tooling**: Hardened `scripts/check_env_keys.py` to strictly enforce consistency between `config.py`, `secrets.ctmpl` (Vault), AND `.env.example` (Docs).
    -   **Outcome**: Impossible to merge undocumented environment variables.

2.  **Frontend Routing (Local vs Staging)**
    -   **Code**: Hardened `apps/frontend/src/lib/api.ts` to automatically strip trailing slashes from `API_URL` and ensure `path` has a leading slash.
    -   **Testing**: Added `api.test.ts` to verify URL normalization logic.
    -   **Documentation**: Updated `apps/frontend/README.md` with strict rules.

3.  **Database Schema (Silent Killers)**
    -   **Guardrail Test**: Created `apps/backend/tests/test_schema_guardrails.py`.
        -   **Enum Check**: Fails if any SQLAlchemy `Enum` lacks a `name="..."` parameter (prevents migration conflicts).
        -   **Migration Check**: Fails if migration filenames are too long (>120 chars).
    -   **Outcome**: CI will block PRs with dangerous schema definitions.

4.  **Data Integrity (The Float Ban)**
    -   **Guardrail Test**: Created `apps/backend/tests/test_decimal_safety.py`.
        -   **Float Injection**: Fuzzes Pydantic models with dangerous floats (`0.1 + 0.2`). Fails if precision artifacts (`0.3000...4`) are preserved.
    -   **Documentation**: Updated `extraction.md` and `accounting.md` to explicitly ban floats.

## Next Steps for Team
- Run `python scripts/check_env_keys.py` locally to fix any existing config drifts.
- Run `moon run backend:test` to see if the new Guardrails catch existing issues (likely will!).
