# Production Deployment Workflow
#
# Triggers: Release tag (v*.*.*)
# Actions: Build images → Deploy to production → Smoke test
#
# Production uses semantic versioning for stability.

name: Deploy Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to deploy (e.g., v1.2.3)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/finance_report
  DOKPLOY_API_URL: https://cloud.zitian.party/api
  PRODUCTION_COMPOSE_ID: lNn9gVS1Zyw79Jzw5dlbu
  DEPLOY_WAIT_SECONDS: 120

jobs:
  verify-and-deploy:
    name: Verify and Deploy
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://report.zitian.party
    steps:
      - name: Log in to Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify Image Exists
        env:
          VERSION: ${{ github.event.inputs.version }}
        run: |
          echo "Verifying image existence for version: $VERSION"
          if ! docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:$VERSION > /dev/null; then
            echo "::error::Backend image for version $VERSION not found!"
            exit 1
          fi
          if ! docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:$VERSION > /dev/null; then
            echo "::error::Frontend image for version $VERSION not found!"
            exit 1
          fi
          echo "Images found. Proceeding with deployment."

      - name: Deploy to Production
        env:
          IMAGE_TAG: ${{ github.event.inputs.version }}
        run: |
          echo "Deploying $IMAGE_TAG to production..."
          
          # Get current env (suppress output to avoid leaking secrets)
          env_response=$(curl -sf -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
            "${{ env.DOKPLOY_API_URL }}/compose.one?composeId=${{ env.PRODUCTION_COMPOSE_ID }}" 2>/dev/null)
          
          if [ $? -ne 0 ] || [ -z "$env_response" ]; then
            echo "ERROR: Failed to fetch current environment from API"
            exit 1
          fi
          
          current_env=$(echo "$env_response" | jq -r '.env // empty')
          
          # Mask any sensitive values
          while IFS= read -r line; do
            case "$line" in
              VAULT_*=*|[A-Z_]*TOKEN=*|[A-Z_]*SECRET=*|[A-Z_]*KEY=*|[A-Z_]*PASSWORD=*)
                value=${line#*=}
                if [ -n "$value" ]; then
                  echo "::add-mask::$value"
                fi
                ;;
            esac
          done <<< "$current_env"
          
          # Update IMAGE_TAG
          if echo "$current_env" | grep -q '^IMAGE_TAG='; then
            new_env=$(echo "$current_env" | sed "s/^IMAGE_TAG=.*/IMAGE_TAG=$IMAGE_TAG/")
          else
            new_env=$(printf "%s\nIMAGE_TAG=%s" "$current_env" "$IMAGE_TAG")
          fi

          # Add/Update NEXT_PUBLIC_APP_URL
          if echo "$new_env" | grep -q '^NEXT_PUBLIC_APP_URL='; then
            new_env=$(echo "$new_env" | sed "s|^NEXT_PUBLIC_APP_URL=.*|NEXT_PUBLIC_APP_URL=https://report.zitian.party|")
          else
            new_env=$(printf "%s\nNEXT_PUBLIC_APP_URL=%s" "$new_env" "https://report.zitian.party")
          fi
          
          # Update environment
          if ! curl -sf -X POST "${{ env.DOKPLOY_API_URL }}/compose.update" \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
            -d "$(jq -n --arg id "${{ env.PRODUCTION_COMPOSE_ID }}" --arg env "$new_env" '{composeId: $id, env: $env}')" > /dev/null; then
            echo "ERROR: Failed to update environment"
            exit 1
          fi
          
          echo "Environment updated to use image tag: $IMAGE_TAG"
          
          # Redeploy
          curl -sf -X POST "${{ env.DOKPLOY_API_URL }}/compose.deploy" \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
            -d "$(jq -n --arg id "${{ env.PRODUCTION_COMPOSE_ID }}" '{composeId: $id}')" > /dev/null
          
          echo "Deployment triggered. Waiting for backend to become healthy..."
          echo ""
          
          # Create temp files and setup cleanup trap
          health_response_file=$(mktemp)
          health_error_file=$(mktemp)
          trap "rm -f '$health_response_file' '$health_error_file'" EXIT INT TERM
          
          max_attempts=24
          attempt=1
          health_url="https://report.zitian.party/api/health"
          
          while (( attempt <= max_attempts )); do
            echo "[WAITING] Health check attempt $attempt/$max_attempts..."
            
            # Capture both HTTP status code and response body
            http_code=$(curl -s -o "$health_response_file" -w "%{http_code}" "$health_url" 2>"$health_error_file" || echo "000")
            
            # Check for connection errors (curl exit code != 0)
            if [ "$http_code" = "000" ]; then
              echo "[WARNING] Connection failed (attempt $attempt/$max_attempts)"
              
              if (( attempt == max_attempts )); then
                timeout=$((max_attempts * 10))
                echo ""
                echo "========================================="
                echo "[FAIL] Deployment Failed: Cannot connect to health endpoint"
                echo "========================================="
                echo "URL: $health_url"
                echo ""
                echo "Connection error:"
                cat "$health_error_file" 2>/dev/null || echo "(no error details)"
                echo ""
                echo "Troubleshooting:"
                echo "1. Check DNS resolution: nslookup report.zitian.party"
                echo "2. Check TLS certificate: curl -v $health_url"
                echo "3. Check SigNoz: https://signoz.zitian.party"
                echo "   Filter: deployment.environment=production service_name=finance-report-backend"
                echo "========================================="
                exit 1
              fi
              
              sleep 10
              ((attempt++))
              continue
            fi
            
            # Check for HTTP errors
            if [ "$http_code" != "200" ]; then
              echo "[WARNING] HTTP $http_code (attempt $attempt/$max_attempts)"
              
              if (( attempt == max_attempts )); then
                timeout=$((max_attempts * 10))
                echo ""
                echo "========================================="
                echo "[FAIL] Deployment Failed: Health endpoint returned HTTP $http_code"
                echo "========================================="
                echo "URL: $health_url"
                echo "Response:"
                cat "$health_response_file" 2>/dev/null || echo "(no response body)"
                echo ""
                echo "Troubleshooting: Check SigNoz for application logs"
                echo "========================================="
                exit 1
              fi
              
              sleep 10
              ((attempt++))
              continue
            fi
            
            # Check if response contains "healthy"
            health_response=$(cat "$health_response_file" 2>/dev/null || echo "")
            if echo "$health_response" | grep -q '"status":"healthy"'; then
              elapsed=$((attempt * 10))
              echo ""
              echo "========================================="
              echo "[SUCCESS] Deployment Successful ($elapsed seconds)"
              echo "========================================="
              echo "Version: $IMAGE_TAG"
              echo "Environment: production"
              echo "URL: https://report.zitian.party"
              echo ""
              echo "Logs: https://signoz.zitian.party"
              echo "Filter: deployment.environment=production service_name=finance-report-backend"
              echo "========================================="
              exit 0
            fi
            
            # Response is 200 but not healthy
            echo "[WARNING] Backend is unhealthy (attempt $attempt/$max_attempts)"
            echo "Response: $health_response"
            
            if (( attempt == max_attempts )); then
              timeout=$((max_attempts * 10))
              echo ""
              echo "========================================="
              echo "[FAIL] Deployment Failed: Backend unhealthy after ${timeout}s"
              echo "========================================="
              echo "Last health check response:"
              echo "$health_response"
              echo ""
              echo "Troubleshooting:"
              echo "1. Check SigNoz: https://signoz.zitian.party"
              echo "   Filter: deployment.environment=production service_name=finance-report-backend"
              echo "2. Look for CHECKPOINT markers in logs"
              echo "========================================="
              exit 1
            fi
            
            sleep 10
            ((attempt++))
          done

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Smoke Tests
        run: |
          echo "Running production smoke tests..."
          chmod +x scripts/smoke_test.sh
          ./scripts/smoke_test.sh https://report.zitian.party
