name: Build, Deploy and Smoke Test

on:
  push:
    branches: [main]
    paths:
      - 'apps/backend/**'
      - 'apps/frontend/**'
      - '.github/workflows/docker-build.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/finance_report
  DEPLOY_URL: https://report.zitian.party

jobs:
  build-backend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Backend
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend
          tags: |
            type=ref,event=branch
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/backend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  build-frontend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Frontend
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend
          tags: |
            type=ref,event=branch
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/frontend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NEXT_PUBLIC_API_URL=https://report.zitian.party/api

  deploy:
    name: Deploy to Production
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
      
      - name: Update compose file with SHA tags
        run: |
          echo "Updating compose file with SHA-tagged images..."
          cd repo/finance_report/finance_report/10.app
          
          # Replace environment variable references with SHA tags
          sed -i "s|\${IMAGE_TAG:-latest}|sha-${{ github.sha }}|g" compose.yaml
          
          echo "Updated compose.yaml image lines:"
          cat compose.yaml | grep "image:"

      - name: Upload updated compose to Dokploy
        run: |
          cd repo/finance_report/finance_report/10.app
          COMPOSE_CONTENT=$(cat compose.yaml | jq -Rs .)
          
          echo "Uploading compose file to Dokploy..."
          curl -s -X POST "https://cloud.zitian.party/api/compose.update" \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
            -d "{\"composeId\": \"${{ secrets.DOKPLOY_COMPOSE_ID }}\", \"composeFile\": $COMPOSE_CONTENT, \"sourceType\": \"raw\"}"

      - name: Stop existing containers
        run: |
          echo "Stopping containers..."
          curl -s -X POST "https://cloud.zitian.party/api/compose.stop" \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
            -d '{"composeId": "${{ secrets.DOKPLOY_COMPOSE_ID }}"}'
          
          echo "Waiting 15 seconds for containers to stop..."
          sleep 15

      - name: Deploy with new images
        run: |
          echo "Deploying with SHA-tagged images (sha-${{ github.sha }})..."
          response=$(curl -s -X POST "https://cloud.zitian.party/api/compose.deploy" \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
            -d '{"composeId": "${{ secrets.DOKPLOY_COMPOSE_ID }}"}' \
            -w "\n%{http_code}")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "Deploy response: $body"
          echo "HTTP Code: $http_code"
          
          if [ "$http_code" != "200" ] && [ "$http_code" != "201" ] && [ "$http_code" != "204" ]; then
            echo "Deployment failed with HTTP $http_code"
            exit 1
          fi
          
          echo "Deployment triggered successfully"

      - name: Wait for deployment to complete
        run: |
          echo "Waiting 90 seconds for containers to pull and restart..."
          sleep 90

  smoke-test:
    name: Smoke Tests
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Test homepage
        run: |
          status=$(curl -sf -o /dev/null -w "%{http_code}" "${{ env.DEPLOY_URL }}/")
          if [ "$status" != "200" ]; then
            echo "Homepage failed: HTTP $status"
            exit 1
          fi
          echo "✓ Homepage OK"

      - name: Test API health
        run: |
          response=$(curl -sf "${{ env.DEPLOY_URL }}/api/health")
          echo "Health response: $response"
          echo "✓ API Health OK"

      - name: Test API docs
        run: |
          status=$(curl -sf -o /dev/null -w "%{http_code}" "${{ env.DEPLOY_URL }}/api/docs")
          if [ "$status" != "200" ]; then
            echo "API docs failed: HTTP $status"
            exit 1
          fi
          echo "✓ API Docs OK"

      - name: Test ping-pong page
        run: |
          status=$(curl -sf -o /dev/null -w "%{http_code}" "${{ env.DEPLOY_URL }}/ping-pong")
          if [ "$status" != "200" ]; then
            echo "Ping-pong page failed: HTTP $status"
            exit 1
          fi
          echo "✓ Ping-Pong Page OK"

      - name: Test reconciliation page
        run: |
          status=$(curl -sf -o /dev/null -w "%{http_code}" "${{ env.DEPLOY_URL }}/reconciliation")
          if [ "$status" != "200" ]; then
            echo "Reconciliation page failed: HTTP $status"
            exit 1
          fi
          echo "✓ Reconciliation Page OK"

      - name: Test API accounts endpoint
        run: |
          response=$(curl -sf "${{ env.DEPLOY_URL }}/api/api/accounts")
          echo "Accounts response: $response"
          echo "✓ Accounts API OK"

      - name: Test API ping endpoint
        run: |
          response=$(curl -sf "${{ env.DEPLOY_URL }}/api/ping")
          echo "Ping response: $response"
          echo "✓ Ping API OK"

      - name: Summary
        run: |
          echo "=========================================="
          echo "All smoke tests passed!"
          echo "Deployment URL: ${{ env.DEPLOY_URL }}"
          echo "=========================================="
