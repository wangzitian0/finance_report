name: Build, Deploy and Smoke Test

on:
  push:
    branches: [main]
    paths:
      - 'apps/backend/**'
      - 'apps/frontend/**'
      - '.github/workflows/docker-build.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/finance_report
  DEPLOY_URL: https://report.zitian.party

jobs:
  build-backend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Backend
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend
          tags: |
            type=ref,event=branch
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/backend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  build-frontend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Frontend
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend
          tags: |
            type=ref,event=branch
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/frontend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NEXT_PUBLIC_API_URL=https://report.zitian.party/api

  deploy:
    name: Deploy to Production
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Update IMAGE_TAG in Dokploy
        run: |
          # Use short SHA (first 7 chars) to match Docker metadata action
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "Updating Dokploy IMAGE_TAG to sha-$SHORT_SHA"
          
          # Get current env vars and update IMAGE_TAG
          current_env=$(curl -s -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
            "https://cloud.zitian.party/api/compose.one?composeId=${{ secrets.DOKPLOY_COMPOSE_ID }}" \
            | jq -r '.env')
          
          # Replace IMAGE_TAG value or append if not exists
          if echo "$current_env" | grep -q "^IMAGE_TAG="; then
            new_env=$(echo "$current_env" | sed "s/^IMAGE_TAG=.*/IMAGE_TAG=sha-$SHORT_SHA/")
          else
            new_env="${current_env}\nIMAGE_TAG=sha-$SHORT_SHA"
          fi
          
          # Update Dokploy with new env
          response=$(curl -s -X POST "https://cloud.zitian.party/api/compose.update" \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
            -d "$(jq -n --arg id "${{ secrets.DOKPLOY_COMPOSE_ID }}" --arg env "$new_env" '{composeId: $id, env: $env}')" \
            -w "\n%{http_code}")
          
          http_code=$(echo "$response" | tail -n1)
          echo "Update response code: $http_code"
          
          if [ "$http_code" != "200" ] && [ "$http_code" != "201" ]; then
            echo "Failed to update IMAGE_TAG"
            exit 1
          fi
          echo "IMAGE_TAG updated to sha-$SHORT_SHA"

      - name: Stop existing containers
        run: |
          echo "Stopping containers..."
          curl -s -X POST "https://cloud.zitian.party/api/compose.stop" \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
            -d '{"composeId": "${{ secrets.DOKPLOY_COMPOSE_ID }}"}'
          
          echo "Waiting 15 seconds for containers to stop..."
          sleep 15

      - name: Deploy with new images
        run: |
          echo "Deploying with SHA-tagged images (sha-${{ github.sha }})..."
          response=$(curl -s -X POST "https://cloud.zitian.party/api/compose.deploy" \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
            -d '{"composeId": "${{ secrets.DOKPLOY_COMPOSE_ID }}"}' \
            -w "\n%{http_code}")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "Deploy response: $body"
          echo "HTTP Code: $http_code"
          
          if [ "$http_code" != "200" ] && [ "$http_code" != "201" ] && [ "$http_code" != "204" ]; then
            echo "Deployment failed with HTTP $http_code"
            exit 1
          fi
          
          echo "Deployment triggered successfully"

      - name: Wait for deployment to complete
        run: |
          echo "Waiting 90 seconds for containers to pull and restart..."
          sleep 90

  smoke-test:
    name: Smoke Tests
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Run smoke tests
        run: bash scripts/smoke_test.sh ${{ env.DEPLOY_URL }}
