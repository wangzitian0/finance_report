name: Build and Update Infrastructure

on:
  push:
    branches: [main]
    paths:
      - 'apps/backend/**'
      - 'apps/frontend/**'
      - '.github/workflows/docker-build.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/finance_report
  DEPLOY_URL: https://report.zitian.party

jobs:
  build-backend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Backend
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend
          tags: |
            type=ref,event=branch
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/backend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  build-frontend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Frontend
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend
          tags: |
            type=ref,event=branch
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/frontend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NEXT_PUBLIC_API_URL=https://report.zitian.party/api

  update-infra:
    name: Update Infrastructure Config
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout finance_report repo
        uses: actions/checkout@v4
        with:
          path: finance_report
      
      - name: Checkout infra2 repo
        uses: actions/checkout@v4
        with:
          repository: wangzitian0/infra2
          path: infra2
          token: ${{ secrets.INFRA2_PAT }}
      
      - name: Update compose file with SHA tags
        run: |
          cd infra2/finance_report/finance_report/10.app
          
          # Use short SHA (first 7 chars) to match Docker metadata action default
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "Updating to sha-$SHORT_SHA"
          
          # Replace IMAGE_TAG environment variable with specific SHA
          sed -i "s|\${IMAGE_TAG:-latest}|sha-$SHORT_SHA|g" compose.yaml
          
          echo "Updated compose.yaml image lines:"
          grep "image:" compose.yaml
      
      - name: Create Pull Request to infra2
        uses: peter-evans/create-pull-request@v5
        with:
          path: infra2
          token: ${{ secrets.INFRA2_PAT }}
          commit-message: "chore: update finance_report images to sha-${{ github.sha }}"
          branch: auto/finance-report-sha-${{ github.sha }}
          title: "Deploy finance_report sha-${{ github.sha }}"
          body: |
            ## Auto-generated deployment PR
            
            Updates finance_report backend and frontend images to:
            - `ghcr.io/wangzitian0/finance_report-backend:sha-${{ github.sha }}`
            - `ghcr.io/wangzitian0/finance_report-frontend:sha-${{ github.sha }}`
            
            Triggered by: ${{ github.event.head_commit.message }}
            Finance Report commit: ${{ github.sha }}
            
            ## Changes
            - Updated `finance_report/finance_report/10.app/compose.yaml`
            
            **Merge this PR to trigger IaC sync and deploy to production.**
          labels: auto-deploy,finance-report
          team-reviewers: wangzitian0
