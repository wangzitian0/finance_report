# Staging Deployment Workflow
#
# Triggers: Push to main branch
# Actions: Build images â†’ Deploy to staging â†’ Smoke test
#
# Staging tracks the latest main branch commit.
# Data is persisted between deployments.

name: Deploy Staging

on:
  push:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/finance_report
  DOKPLOY_API_URL: https://cloud.zitian.party/api
  STAGING_COMPOSE_ID: A6V-hbJlgHMwgPDoTDnhH

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    permissions:
      packages: write
    outputs:
      commit_sha: ${{ steps.get_sha.outputs.short_sha }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get Commit SHA
        id: get_sha
        run: |
          short_sha=$(git rev-parse --short HEAD)
          echo "short_sha=$short_sha"  >> "$GITHUB_OUTPUT"
          echo "Deploying commit: $short_sha"

      - name: Log in to Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./apps/backend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:${{ steps.get_sha.outputs.short_sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:staging

      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./apps/frontend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:${{ steps.get_sha.outputs.short_sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:staging
          build-args: |
            NEXT_PUBLIC_API_URL=https://report-staging.zitian.party
            NEXT_PUBLIC_APP_URL=https://report-staging.zitian.party

      - name: Check Deployment Dependencies
        env:
          DOKPLOY_API_KEY: ${{ secrets.DOKPLOY_API_KEY }}
          DOKPLOY_API_URL: ${{ env.DOKPLOY_API_URL }}
        run: bash scripts/check_deployment_deps.sh

      - name: Deploy to Staging
        env:
          IMAGE_TAG: ${{ steps.get_sha.outputs.short_sha }}
          DOKPLOY_API_KEY: ${{ secrets.DOKPLOY_API_KEY }}
          DOKPLOY_API_URL: ${{ env.DOKPLOY_API_URL }}
        run: |
          bash scripts/dokploy_deploy.sh \
            "${{ env.STAGING_COMPOSE_ID }}" \
            "$IMAGE_TAG" \
            "https://report-staging.zitian.party"
          
          echo "Deployment triggered. Waiting for backend to become healthy..."
          bash scripts/health_check.sh \
            "https://report-staging.zitian.party/api/health" \
            "staging" \
            36 \
            "$IMAGE_TAG"

      - name: Setup E2E Tests
        uses: ./.github/actions/setup-e2e-tests

      - name: End-to-End Tests
        env:
          APP_URL: https://report-staging.zitian.party
          TEST_ENV: staging
          SKIP_UI_TESTS: false
        run: |
          echo "ðŸš€ Starting E2E Pipeline for $APP_URL"
          
          echo "--- Phase 1: Smoke Check (Shell) ---"
          bash scripts/smoke_test.sh "$APP_URL" staging
          
          echo "--- Phase 2: Core Flow Validation (Python) ---"
          # Run full suite including UI tests since SKIP_UI_TESTS=false
          pytest tests/e2e -v -m "smoke or e2e"
          
          echo "âœ… Staging E2E Pipeline passed!"

      - name: Performance Benchmark
        continue-on-error: true  # Don't block deploy, but report issues
        run: |
          echo "Running API performance benchmark..."
          BASE_URL="https://report-staging.zitian.party"
          
          # Test key endpoints
          for endpoint in /api/health /api/ping; do
            response_time=$(curl -sf -w "%{time_total}" -o /dev/null "$BASE_URL$endpoint" 2>/dev/null || echo "failed")
            
            if [ "$response_time" = "failed" ]; then
              echo "::warning::$endpoint - Failed to connect"
            elif (( $(echo "$response_time > 2.0" | bc -l 2>/dev/null || echo 0) )); then
              echo "::warning::$endpoint - Slow: ${response_time}s (> 2s threshold)"
            else
              echo "âœ… $endpoint - ${response_time}s"
            fi
          done
          
          echo "Performance benchmark complete."
