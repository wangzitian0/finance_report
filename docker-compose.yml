# Unified Docker Compose Configuration
# 
# Controls all 6 environments via Profiles and Environment Variables.
#
# Profiles:
#   - infra: Starts Postgres, Redis, MinIO (Local Dev, PR)
#   - app:   Starts Backend, Frontend (PR, Prod, Staging)
#
# Variables:
#   - DB_PORTS: Port mapping for DB (Default: 127.0.0.1:5432:5432 for Local)
#   - TRAEFIK_ENABLE: Enable routing (Default: false)
#   - ENV_SUFFIX: Isolation suffix (Default: empty)

services:
  postgres:
    image: postgres:15-alpine
    container_name: finance-report-db${ENV_SUFFIX:-}
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-finance_report}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      # Local: "127.0.0.1:5432:5432"
      # PR: "" (Internal only) or specific binding
      - "${DB_PORTS:-127.0.0.1:5432:5432}"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - internal
    profiles: ["infra"]

  redis:
    image: redis:7-alpine
    container_name: finance-report-redis${ENV_SUFFIX:-}
    restart: ${RESTART_POLICY:-unless-stopped}
    volumes:
      - redis_data:/data
    ports:
      - "${REDIS_PORTS:-127.0.0.1:6379:6379}"
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - internal
    profiles: ["infra"]

  minio:
    image: minio/minio
    container_name: finance-report-minio${ENV_SUFFIX:-}
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio_local_secret}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    ports:
      - "${MINIO_API_PORTS:-127.0.0.1:9000:9000}"
      - "${MINIO_CONSOLE_PORTS:-127.0.0.1:9001:9001}"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - internal
    profiles: ["infra"]

  minio-init:
    image: minio/mc
    container_name: finance-report-minio-init${ENV_SUFFIX:-}
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      echo 'Waiting for MinIO...';
      for i in \$(seq 1 10); do
        if mc alias set local http://minio:9000 ${MINIO_ROOT_USER:-minio} ${MINIO_ROOT_PASSWORD:-minio_local_secret}; then
          echo 'MinIO alias set.';
          break;
        fi;
        echo 'Retrying...';
        sleep 2;
      done;
      mc mb local/${S3_BUCKET:-statements} --ignore-existing;
      exit 0;
      "
    networks:
      - internal
    profiles: ["infra"]

  backend:
    # Prod: Pulls this image
    image: ${REGISTRY:-ghcr.io}/${IMAGE_PREFIX:-wangzitian0/finance_report}-backend:${IMAGE_TAG:-latest}
    # PR: Builds this context
    build:
      context: ./apps/backend
      dockerfile: Dockerfile
      args:
        GIT_COMMIT_SHA: ${GIT_COMMIT_SHA:-}
    container_name: finance-report-backend${ENV_SUFFIX:-}
    restart: ${RESTART_POLICY:-unless-stopped}
    # Dependencies depend on profile! 
    # Docker Compose handles this: if postgres is not started (profile off), depends_on is ignored or handled gracefully?
    # Actually, if profile is off, the service doesn't exist.
    # We need to be careful here. In Prod (profile=app), postgres (profile=infra) is OFF.
    # So depends_on will FAIL if we are not careful.
    # SOLUTION: We remove explicit depends_on for DB in shared file, 
    # OR we assume Prod environment manages startup order differently (it does, via retries).
    # For now, we leave depends_on, but if 'postgres' is disabled, Compose v2 might complain.
    # Let's keep it simple: Backend handles DB connection retries internally.
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@${DB_HOST:-postgres}:5432/${POSTGRES_DB:-finance_report}
      REDIS_URL: ${REDIS_URL:-redis://${REDIS_HOST:-redis}:6379}
      S3_ENDPOINT: ${S3_ENDPOINT:-http://${S3_HOST:-minio}:9000}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-minio}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-minio_local_secret}
      S3_BUCKET: ${S3_BUCKET:-statements}
      BASE_CURRENCY: ${BASE_CURRENCY:-SGD}
      PRIMARY_MODEL: ${PRIMARY_MODEL:-google/gemini-2.0-flash-exp:free}
      FALLBACK_MODELS: ${FALLBACK_MODELS:-google/gemini-flash-1.5-8b:free,mistralai/pixtral-12b:free}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      OPENROUTER_DAILY_LIMIT_USD: ${OPENROUTER_DAILY_LIMIT_USD:-2}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://localhost:3001}
      CORS_ORIGIN_REGEX: ${CORS_ORIGIN_REGEX:-https://.*\.zitian\.party}
      DEBUG: ${DEBUG:-false}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-}
      OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME:-finance-report-backend}
      OTEL_RESOURCE_ATTRIBUTES: ${OTEL_RESOURCE_ATTRIBUTES:-deployment.environment=development}
    networks:
      - internal
      - dokploy-network
    labels:
      - "traefik.enable=${TRAEFIK_ENABLE:-false}"
      - "traefik.docker.network=dokploy-network"
      - "traefik.http.routers.finance-report-api${ENV_SUFFIX:-}.rule=Host(`report${ENV_DOMAIN_SUFFIX:-}.${INTERNAL_DOMAIN:-zitian.party}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.finance-report-api${ENV_SUFFIX:-}.entrypoints=websecure"
      - "traefik.http.routers.finance-report-api${ENV_SUFFIX:-}.tls.certresolver=letsencrypt"
      - "traefik.http.routers.finance-report-api${ENV_SUFFIX:-}.service=finance-report-api${ENV_SUFFIX:-}"
      - "traefik.http.services.finance-report-api${ENV_SUFFIX:-}.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.finance-report-api-strip${ENV_SUFFIX:-}.stripprefix.prefixes=/api"
      - "traefik.http.routers.finance-report-api${ENV_SUFFIX:-}.middlewares=finance-report-api-strip${ENV_SUFFIX:-}@docker"
    profiles: ["app"]

  frontend:
    image: ${REGISTRY:-ghcr.io}/${IMAGE_PREFIX:-wangzitian0/finance_report}-frontend:${IMAGE_TAG:-latest}
    build:
      context: ./apps/frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-}
        NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-}
    container_name: finance-report-frontend${ENV_SUFFIX:-}
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-}
    networks:
      - internal
      - dokploy-network
    labels:
      - "traefik.enable=${TRAEFIK_ENABLE:-false}"
      - "traefik.docker.network=dokploy-network"
      - "traefik.http.routers.finance-report-web${ENV_SUFFIX:-}.rule=Host(`report${ENV_DOMAIN_SUFFIX:-}.${INTERNAL_DOMAIN:-zitian.party}`)"
      - "traefik.http.routers.finance-report-web${ENV_SUFFIX:-}.entrypoints=websecure"
      - "traefik.http.routers.finance-report-web${ENV_SUFFIX:-}.tls.certresolver=letsencrypt"
      - "traefik.http.routers.finance-report-web${ENV_SUFFIX:-}.service=finance-report-web${ENV_SUFFIX:-}"
      - "traefik.http.services.finance-report-web${ENV_SUFFIX:-}.loadbalancer.server.port=3000"
    profiles: ["app"]

volumes:
  postgres_data:
  redis_data:
  minio_data:

networks:
  dokploy-network:
    name: dokploy-network
    external: true
  internal:
    name: finance-report-internal${ENV_SUFFIX:-}
