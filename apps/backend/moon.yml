$schema: 'https://moonrepo.dev/schemas/project.json'

language: python
type: application

fileGroups:
  sources:
    - 'src/**/*.py'
  tests:
    - 'tests/**/*.py'

tasks:
  install:
    command: 'uv sync'
    inputs:
      - 'pyproject.toml'
    outputs:
      - '.venv'

  dev:
    command: 'python ../../scripts/dev_backend.py'
    local: true
    deps:
      - 'install'

  lint:
    command: 'uv run ruff check src/'
    inputs:
      - '@globs(sources)'
    deps:
      - 'install'

  format:
    command: 'uv run ruff format src/'
    local: true
    deps:
      - 'install'

  format-check:
    command: 'uv run ruff format src/ --check'
    deps:
      - 'install'

  test:
    command: 'python ../../scripts/test_lifecycle.py'
    inputs:
      - '@globs(sources)'
      - '@globs(tests)'
    deps:
      - 'install'

  test-execution:
    command: 'uv run pytest -n auto --dist worksteal -v -m "not slow and not e2e" --cov=src --cov-report=lcov --cov-report=term-missing --cov-branch --cov-fail-under=92'
    inputs:
      - '@globs(sources)'
      - '@globs(tests)'
    deps:
      - 'install'

  test-integration:
    command: 'uv run pytest -m integration tests/'

  test-e2e:
    command: 'uv run pytest -m e2e tests/e2e/'
    inputs:
      - '@globs(sources)'
      - 'tests/e2e/**/*.py'
    deps:
      - 'install'
    env:
      PLAYWRIGHT_BROWSERS_PATH: '.playwright'

  test-perf:
    command: 'uv run locust -f tests/locustfile.py --host=http://localhost:8000 --users 10 --spawn-rate 2 --run-time 30s --headless --html=locust_report.html'
    local: true
    deps:
      - 'install'
  migrate:
    command: 'uv run alembic upgrade head'
    local: true
    deps:
      - 'install'

  env-check:
    command: 'uv run python -m src.boot --mode=full'
    local: true
    deps:
      - 'install'

  env-check-quick:
    command: 'uv run python -m src.boot --mode=dry-run'
    local: true
    deps:
      - 'install'

  verify:
    command: 'echo "âœ… Verify complete. all systems go."'
    local: true
    deps:
      - 'lint'
      - 'format-check'
      - 'test'
      - 'env-check'

  ci:
    command: 'echo "CI pipeline complete"'
    local: true
    deps:
      - 'lint'
      - 'format-check'
      - 'test-execution'
      - 'env-check-quick'
